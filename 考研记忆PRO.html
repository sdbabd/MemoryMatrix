<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>è€ƒç ”è®°å¿† Pro</title>
    
    <!-- KaTeX CSS -->
    <link rel="stylesheet" href="https://npm.elemecdn.com/katex@0.16.9/dist/katex.min.css"
          onerror="this.href='https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css'">
    <!-- KaTeX JS -->
    <script src="https://npm.elemecdn.com/katex@0.16.9/dist/katex.min.js"
            onerror="this.src='https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js'"></script>
    <script src="https://npm.elemecdn.com/katex@0.16.9/dist/contrib/auto-render.min.js"
            onerror="this.src='https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js'"></script>

    <style>
        :root {
            --bg-body: #f3f5f7;
            --bg-card: #ffffff;
            --text-main: #1f2937;
            --text-sub: #4b5563;
            
            --primary: #3b82f6;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            
            /* çƒ­åŠ›å›¾ç²¾ç»†è‰²é˜¶ */
            --heat-0: rgba(16, 185, 129, 0.1);  /* 0é”™ */
            --heat-1: rgba(253, 224, 71, 0.5);  /* 1-2é”™ */
            --heat-2: rgba(251, 146, 60, 0.6);  /* 3-4é”™ */
            --heat-3: rgba(239, 68, 68, 0.7);   /* 5-7é”™ */
            --heat-4: rgba(124, 58, 237, 0.7);  /* 8+é”™ */

            --radius: 16px;
            --card-width: 760px;
            --line-height: 2.2; 
            --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.01);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Header --- */
        .header {
            height: 64px;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(0,0,0,0.06);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            z-index: 50;
            flex-shrink: 0;
        }

        .header-left { display: flex; flex-direction: column; }
        .brand { font-weight: 800; font-size: 1.05rem; color: var(--text-main); }
        .subtitle { font-size: 0.75rem; color: var(--text-sub); margin-top: 2px; }

        .header-actions { display: flex; gap: 10px; }
        .icon-btn {
            width: 38px; height: 38px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            background: #fff;
            color: var(--text-sub);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .icon-btn:active { transform: scale(0.95); background: #f9fafb; }

        /* --- Stats Dashboard --- */
        .stats-dash {
            background: #fff;
            padding: 10px 0;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            border-bottom: 1px solid rgba(0,0,0,0.03);
            flex-shrink: 0;
        }
        
        .stat-box {
            display: flex; flex-direction: column; align-items: center;
            border-right: 1px solid #f3f4f6;
        }
        .stat-box:last-child { border-right: none; }
        
        .stat-label { font-size: 0.7rem; color: var(--text-sub); text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-value { font-size: 1.1rem; font-weight: 700; color: var(--text-main); margin-top: 2px; }
        .stat-value.bad { color: var(--error); }
        .stat-value.good { color: var(--success); }

        /* --- Stage --- */
        .stage {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .card {
            background: var(--bg-card);
            width: 100%;
            max-width: var(--card-width);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 36px;
            min-height: 400px;
            transition: opacity 0.2s ease;
        }
        .card.fade-out { opacity: 0; }

        .card-title {
            font-size: 1.3rem;
            font-weight: 800;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #f3f4f6;
            line-height: 1.4;
            color: var(--text-main);
        }

        .card-content {
            font-size: 1.05rem;
            line-height: var(--line-height);
            color: var(--text-sub);
            text-align: justify;
        }
        
        /* é’ˆå¯¹KaTeXè°ƒæ•´è¡Œé«˜ï¼Œé˜²æ­¢å…¬å¼æ‹¥æŒ¤ */
        .katex { font-size: 1.1em; line-height: 1.2; }

        /* --- Cloze Items --- */
        .cloze {
            padding: 1px 4px;
            margin: 0 2px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 2px solid transparent;
            display: inline-block; /* ä¿è¯å—çŠ¶å®Œæ•´æ€§ */
            vertical-align: text-bottom;
        }

        /* ç»ƒä¹ æ¨¡å¼ - é®æŒ¡æ€ */
        .cloze.masked {
            background-color: #e5e7eb;
            color: transparent !important; /* æ–‡å­—é€æ˜ */
            user-select: none;
            min-width: 1.5em;
            position: relative;
        }

        /* å…³é”® CSSï¼šè®© KaTeX åœ¨ masked çŠ¶æ€ä¸‹å®Œå…¨éšè—ä½†å ä½ */
        .cloze.masked .katex {
            opacity: 0; 
            visibility: hidden; /* åŒé‡ä¿é™©ï¼Œé˜²æ­¢æ®‹å½± */
        }
        
        /* Focus Mode Highlight */
        .cloze.active-focus {
            background-color: #fffbeb;
            color: var(--text-main);
            border-bottom: 2px solid var(--warning);
            box-shadow: 0 0 0 4px rgba(255,255,255,0.9), 0 0 0 6px var(--warning);
            position: relative;
            z-index: 1001;
        }

        .cloze.correct { color: var(--success); border-bottom-color: var(--success); cursor: default; }
        .cloze.wrong { color: var(--error); border-bottom-color: var(--error); cursor: default; }

        /* --- Heatmap Span --- */
        .heat-span {
            padding: 1px 3px;
            border-radius: 4px;
            margin: 0 1px;
            display: inline-block;
        }

        /* --- Footer Controls --- */
        .footer {
            background: #fff;
            padding: 16px 24px;
            border-top: 1px solid #f3f4f6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            z-index: 40;
        }

        .btn-pill {
            border: none;
            background: #f3f4f6;
            padding: 12px 24px;
            border-radius: 30px;
            font-weight: 600;
            color: var(--text-main);
            cursor: pointer;
            display: flex; align-items: center; gap: 6px;
        }
        .btn-pill.primary { background: var(--text-main); color: #fff; }
        .btn-pill:disabled { opacity: 0.4; cursor: not-allowed; }

        /* --- Overlays & Modals --- */
        .overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
            opacity: 0; pointer-events: none;
            transition: opacity 0.3s;
        }
        .overlay.active { opacity: 1; pointer-events: auto; }

        /* Decision Menu */
        .pop-menu {
            position: absolute; z-index: 1002;
            display: none; background: #fff;
            padding: 8px; border-radius: 12px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.15);
            animation: popUp 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @keyframes popUp { from{transform:scale(0.8) translateY(10px);opacity:0} to{transform:scale(1) translateY(0);opacity:1} }
        
        .d-btn {
            border: none; padding: 10px 24px;
            border-radius: 8px; font-weight: 600; font-size: 1rem;
            color: #fff; cursor: pointer; margin: 0 4px;
        }
        .yes { background: var(--success); }
        .no { background: var(--error); }

        /* Fullscreen Modal (Heatmap & Settings) */
        .modal-sheet {
            position: fixed; inset: 0;
            background: var(--bg-body);
            z-index: 2000;
            display: flex; flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .modal-sheet.open { transform: translateY(0); }

        .sheet-header {
            padding: 16px 24px; background: #fff;
            border-bottom: 1px solid #e5e7eb;
            display: flex; justify-content: space-between; align-items: center;
        }
        .sheet-title { font-weight: 700; font-size: 1.1rem; }
        
        .sheet-body { flex: 1; overflow-y: auto; padding: 24px; max-width: 800px; margin: 0 auto; width: 100%; }

        /* Legend for Heatmap */
        .legend-bar { display: flex; gap: 12px; margin-top: 10px; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 6px; font-size: 0.75rem; color: var(--text-sub); }
        .color-dot { width: 12px; height: 12px; border-radius: 4px; }

        /* Settings UI */
        .setting-group { background: #fff; padding: 20px; border-radius: 12px; margin-bottom: 15px; }
        .setting-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-weight: 600; }
        input[type=range] { width: 100%; accent-color: var(--primary); }
        
        /* --- Reset Dialog --- */
        .reset-dialog {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 32px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            text-align: center;
            z-index: 1001;
            min-width: 300px;
            max-width: 90%;
        }

        .reset-icon {
            font-size: 3rem;
            margin-bottom: 16px;
        }

        .reset-dialog h3 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--text-main);
        }

        .reset-dialog p {
            color: var(--text-sub);
            line-height: 1.5;
            margin-bottom: 24px;
        }

        .reset-dialog small {
            color: #9ca3af;
            font-size: 0.85rem;
        }

        .reset-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .btn-reset {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 100px;
        }

        .btn-reset.yes {
            background: var(--primary);
            color: white;
        }

        .btn-reset.yes:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }

        .btn-reset.no {
            background: #f3f4f6;
            color: var(--text-main);
        }

        .btn-reset.no:hover {
            background: #e5e7eb;
            transform: translateY(-1px);
        }

        
        .btn-reset:active {
            transform: scale(0.98);
        }

        @media (max-width: 600px) {
            .card { padding: 24px; border-radius: 0; min-height: 60vh; box-shadow: none; }
            .stage { padding: 0; }
            .header-left { flex:1; }
            .stats-dash { padding: 10px; }
            .stat-value { font-size: 1rem; }
            .reset-dialog {
                padding: 24px;  
                min-width: auto;
            }
        }
    </style>
</head>
<body>

    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="header">
        <div class="header-left">
            <div class="brand">è€ƒç ”è®°å¿† Pro</div>
            <div class="subtitle" id="progress-text">1 / 1</div>
        </div>
        <div class="header-actions">
            <button class="icon-btn" onclick="openSettings()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
            </button>
            <button class="icon-btn" style="color:var(--error); border-color:var(--error); background:#fff5f5;" onclick="openHeatmap()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.1.2-2.2.5-3.3a9 9 0 0 0 2.5 2.8z"></path></svg>
            </button>
        </div>
    </header>

    <!-- æ•°æ®ä»ªè¡¨ç›˜ -->
    <div class="stats-dash">
        <div class="stat-box">
            <span class="stat-label">é—å¿˜æ¬¡æ•°</span>
            <span class="stat-value" id="disp-wrong-count">0</span>
        </div>
        <div class="stat-box">
            <span class="stat-label">é”™è¯¯ç‡</span>
            <span class="stat-value" id="disp-error-rate">0%</span>
        </div>
        <div class="stat-box">
            <span class="stat-label">å¹³å‡è€—æ—¶</span>
            <span class="stat-value" id="disp-avg-time">0s</span>
        </div>
    </div>

    <!-- ç»ƒä¹ èˆå° -->
    <div class="stage">
        <div class="card" id="card-container">
            <!-- åŠ¨æ€å†…å®¹ -->
        </div>
    </div>

    <!-- åº•éƒ¨æ§åˆ¶ -->
    <div class="footer">
        <button class="btn-pill" id="btn-prev" onclick="changePage(-1)">ä¸Šä¸€é¢˜</button>
        <button class="btn-pill primary" id="btn-next" onclick="changePage(1)">ä¸‹ä¸€é¢˜</button>
    </div>

    <!-- ä¸“æ³¨æ¨¡å¼é®ç½©ä¸èœå• -->
    <div class="overlay" id="focus-overlay"></div>
    <div class="pop-menu" id="decision-menu">
        <button class="d-btn yes" onclick="submitJudgment(true)">è®°å¾—</button>
        <button class="d-btn no" onclick="submitJudgment(false)">å¿˜äº†</button>
    </div>

    <!-- 1. çƒ­åŠ›å›¾æ¨¡æ€æ¡† -->
    <div class="modal-sheet" id="heatmap-modal">
        <div class="sheet-header">
            <div>
                <div class="sheet-title">è®°å¿†çƒ­åŠ›å›¾</div>
                <div class="legend-bar">
                    <div class="legend-item"><div class="color-dot" style="background:var(--heat-0)"></div>0æ¬¡</div>
                    <div class="legend-item"><div class="color-dot" style="background:var(--heat-1)"></div>1-2æ¬¡</div>
                    <div class="legend-item"><div class="color-dot" style="background:var(--heat-2)"></div>3-4æ¬¡</div>
                    <div class="legend-item"><div class="color-dot" style="background:var(--heat-3)"></div>5-7æ¬¡</div>
                    <div class="legend-item"><div class="color-dot" style="background:var(--heat-4)"></div>8æ¬¡+</div>
                </div>
            </div>
            <button class="icon-btn" onclick="closeModal('heatmap-modal')">âœ•</button>
        </div>
        <div class="sheet-body card-content" id="heatmap-content"></div>
    </div>

    <!-- 2. è®¾ç½®æ¨¡æ€æ¡† -->
    <div class="modal-sheet" id="settings-modal">
        <div class="sheet-header">
            <div class="sheet-title">å­¦ä¹ è®¾ç½®</div>
            <button class="icon-btn" onclick="closeModal('settings-modal')">âœ•</button>
        </div>
        <div class="sheet-body">
            <div class="setting-group">
                <div class="setting-header">
                    <span>é®æŒ¡ç‡ (éš¾åº¦)</span>
                    <span id="setting-rate-val">50%</span>
                </div>
                <input type="range" id="rate-slider" min="20" max="90" step="10" value="50" oninput="updateSliderUI(this.value)">
                <p style="font-size:0.85rem; color:#9ca3af; margin-top:10px;">
                    æ³¨æ„ï¼šä¿®æ”¹é®æŒ¡ç‡å°†é‡æ–°ç”Ÿæˆæ‰€æœ‰é¢˜ç›®ï¼Œå¹¶æ¸…ç©ºå½“å‰çš„"æœ¬æ¬¡ç»ƒä¹ çŠ¶æ€"ï¼Œä½†ä¼šä¿ç•™æ‚¨çš„å†å²è®°å¿†æ•°æ®ï¼ˆçƒ­åŠ›å›¾æ•°æ®ï¼‰ã€‚
                </p>
            </div>

            <button class="btn-pill" style="width:100%; justify-content:center; background:#ef4444; color:#fff;" onclick="resetAllData()">
                æ¸…ç©ºæ‰€æœ‰å†å²æ•°æ®ï¼ˆåŒ…æ‹¬çƒ­åŠ›å›¾æ•°æ®ï¼‰è°¨æ…ç‚¹å‡»
            </button>
        </div>
        <div class="footer">
            <button class="btn-pill primary" style="width:100%; justify-content:center;" onclick="saveSettings()">ä¿å­˜å¹¶åº”ç”¨</button>
        </div>
    </div>

    <!-- 3. é‡ç½®ç¡®è®¤æ¨¡æ€æ¡† -->
    <div class="overlay" id="reset-overlay">
        <div class="reset-dialog">
            <div class="reset-icon">ğŸ“š</div>
            <h3>é¢˜ç›®å·²åšå®Œ</h3>
            <p>æ˜¯å¦é‡æ–°å¼€å§‹ç»ƒä¹ ï¼Ÿ<br><small>æ‚¨çš„å†å²è®°å¿†æ•°æ®ï¼ˆçƒ­åŠ›å›¾ï¼‰å°†è¢«ä¿ç•™</small></p>
            <div class="reset-buttons">
                <button class="btn-reset yes" onclick="confirmReset()">é‡æ–°å¼€å§‹</button>
                <button class="btn-reset no" onclick="cancelReset()">ç»§ç»­æŸ¥çœ‹</button>
            </div>
        </div>
    </div>
    
    <script>
        /* ================= æ•°æ®å±‚ (LaTeX æ¸…æ´—å) ================= */
        const STORAGE_KEY = 'memory_pro_latex_v6';
        
        // æ³¨æ„ï¼šLaTeX ä½¿ç”¨ $ åŒ…è£¹ï¼Œå¤æ‚å…¬å¼è¯·ç¡®ä¿è¯­æ³•æ­£ç¡®
        const questions = [
            {
                "title": "1. å™è¿°æ—¶åŸŸé‡‡æ ·å®šç†",
                "content": "å¯¹å¸¦é™ä¿¡å·è¿›è¡Œç­‰é—´éš”é‡‡æ ·ï¼Œåˆ™é‡‡æ ·ä¿¡å·çš„é¢‘è°±æ˜¯åŸæ¨¡æ‹Ÿä¿¡å·çš„é¢‘è°±ä¸€é‡‡æ ·è§’é¢‘ç‡ $\\omega_s = \\frac{2\\pi}{T}$ ï¼ˆ$T$ ä¸ºé‡‡æ ·é—´éš”ï¼‰ä¸ºå‘¨æœŸè¿›è¡Œå»¶æ‹“åå½¢æˆçš„ã€‚ä¸”åªæœ‰å½“æ»¡è¶³å¥ˆå¥æ–¯ç‰¹æ¡ä»¶ï¼Œå³é‡‡æ ·é¢‘ç‡ $\\omega_s$ å¤§äºç­‰äºå¸¦é™ä¿¡å·ä¸¤å€æœ€é«˜æˆªæ­¢é¢‘ç‡æ—¶ï¼Œç”¨ä¸€ç†æƒ³ä½é€šæ»¤æ³¢å™¨å¯ä»¥æ¢å¤åŸå§‹ä¿¡å·ã€‚"
            },
            {
                "title": "2. LTã€FTã€ZTã€DFTã€DTFT ä¹‹é—´çš„å…³ç³»",
                "content": "æ‹‰æ™®æ‹‰æ–¯å˜æ¢å°†é¢‘ç‡ä»å®æ•°æ¨å¹¿ä¸ºå¤æ•°ï¼Œå› è€Œå‚…é‡Œå¶å˜æ¢æ˜¯æ‹‰æ™®æ‹‰æ–¯å˜æ¢çš„ç‰¹ä¾‹ã€‚å½“ $s$ ä¸ºçº¯è™šæ•°æ—¶ï¼ˆ$s = j\\omega$ï¼‰ï¼Œ$x(t)$ çš„æ‹‰æ™®æ‹‰æ–¯å˜æ¢ï¼Œå³ä¸º $x(t)$ çš„å‚…é‡Œå¶å˜æ¢ã€‚Z å˜æ¢æ˜¯å‘¨æœŸé‡‡æ ·ä¿¡å·çš„æ‹‰æ°å˜æ¢çš„è¡¨è¾¾æ–¹å¼ï¼ˆ$z = e^{sT}$ï¼‰ã€‚\nç¦»æ•£æ—¶é—´å‚…é‡Œå¶å˜æ¢ DTFT åˆæ˜¯ Z å˜æ¢çš„ç‰¹ä¾‹ã€‚å½“ $|z| = 1$ï¼Œå³åœ¨å•ä½åœ†ä¸Šæ—¶ï¼ˆ$z = e^{j\\omega}$ï¼‰ï¼Œå¾—åˆ°çš„å°±æ˜¯ DTFT å˜æ¢ã€‚\nç¦»æ•£å‚…é‡Œå¶å˜æ¢ DFT æ˜¯ DTFT åœ¨ $0 - 2\\pi$ å‘¨æœŸå†…çš„ç­‰é—´éš”æŠ½æ ·ï¼ˆ$\\omega = \\frac{2\\pi}{N} k$ï¼‰ï¼Œæˆ–ç­‰åŒäº Z å˜æ¢åœ¨å•ä½åœ†ä¸Šçš„ç­‰é—´éš”æŠ½æ ·ï¼ˆ$z = e^{j\\frac{2\\pi}{N} k}$ï¼‰ã€‚"
            },
            {
                "title": "3. æ‹‰å¼å˜æ¢å’Œ Z å˜æ¢çš„å¯¹åº”å…³ç³»æ˜¯ä»€ä¹ˆï¼Ÿ",
                "content": "ç”±å¯¹åº”å…¬å¼ $z = e^{sT} = e^{(\\sigma + j\\omega)T} = r e^{j\\theta}$ å¯çŸ¥\n$s$ å¹³é¢çš„å·¦åŠå¹³é¢ï¼ˆ$\\sigma < 0$ï¼‰æ˜ å°„åˆ° $z$ å¹³é¢å•ä½åœ†çš„åœ†å†…ï¼ˆ$|z| < 1$ï¼‰ï¼›$s$ å¹³é¢çš„å³åŠå¹³é¢ï¼ˆ$\\sigma > 0$ï¼‰æ˜ å°„åˆ° $z$ å¹³é¢å•ä½åœ†çš„åœ†å¤–ï¼ˆ$|z| > 1$ï¼‰ï¼›$s$ å¹³é¢çš„è™šè½´ï¼ˆ$\\sigma = 0$ï¼‰æ˜ å°„åˆ° $z$ å¹³é¢çš„å•ä½åœ†ï¼ˆ$|z| = 1$ï¼‰ï¼›"
            },
            {
                "title": "4. ä»€ä¹ˆæ˜¯æ— å¤±çœŸä¼ è¾“ï¼Œæ¡ä»¶æ˜¯ä»€ä¹ˆï¼Ÿ",
                "content": "ä¿¡å·çš„æ— å¤±çœŸä¼ è¾“è¦æ±‚è¾“å‡ºå“åº”çš„æ³¢å½¢åº”å½“ä¸ç³»ç»Ÿè¾“å…¥æ¿€åŠ±ä¿¡å·çš„æ³¢å½¢å®Œå…¨ç›¸åŒï¼Œè€Œå¹…åº¦å¤§å°å¯ä»¥ä¸åŒï¼Œæ—¶é—´å‰åå¯æœ‰æ‰€å·®å¼‚ã€‚\nå³æ»¡è¶³æ¡ä»¶å…¬å¼ $y(t) = K\\cdot x(t - t_0)$ çš„ç³»ç»Ÿç§°ä¸ºæ— å¤±çœŸä¼ è¾“ç³»ç»Ÿã€‚"
            },
            {
                "title": "5. è°ƒåˆ¶åŠå…¶ä¸»è¦ä½œç”¨",
                "content": "è°ƒåˆ¶æ˜¯å°†ä¿¡å·ä»ä½é¢‘æ®µæ¬ç§»åˆ°é€‚åˆè¿œè·ç¦»ä¼ è¾“çš„é«˜é¢‘æ®µçš„è¿‡ç¨‹ã€‚å…¶ä¸»è¦ä½œç”¨æ˜¯æé«˜ä¿¡å·åœ¨ä¿¡é“ä¸Šçš„ä¼ è¾“æ•ˆç‡ï¼Œæˆ–æ˜¯è¾¾åˆ°ä¿¡å·å¤ç”¨çš„ç›®çš„ï¼Œæˆ–æ˜¯å‡å°‘ä¼ è¾“å¼•èµ·çš„å¤±çœŸï¼Œæˆ–æ˜¯ä½¿å¤©çº¿å°ºå¯¸å˜å°ã€‚"
            },
            {
                "title": "6. AMã€DSBã€SSB è”ç³»å’ŒåŒºåˆ«",
                "content": "å®ƒä»¬ä¹‹é—´çš„è”ç³»æ˜¯éƒ½ä¸ºå¹…åº¦è°ƒåˆ¶ï¼ŒAM æ˜¯è°ƒå¹…ï¼Œå¸¦è½½æ³¢ï¼›DSB æ˜¯æŠ‘åˆ¶è½½æ³¢çš„è°ƒå¹…ï¼Œå¯å¢åŠ åŠŸç‡æ•ˆç‡ï¼Œä½†ä¸¤ä¸ªè¾¹å¸¦å‡ä¼ è¾“ç›¸åŒçš„ä¿¡æ¯ï¼›SSB å•è¾¹å¸¦æŠ‘åˆ¶äº†ä¸€ä¸ªè¾¹å¸¦ï¼Œç›¸å¯¹ DSB å‡å°‘äº†ä¸€åŠå¸¦å®½ï¼Œå› æ­¤å¸¦å®½æ•ˆç‡ç¿»å€ã€‚"
            },
            {
                "title": "7. å¤šè·¯å¤ç”¨ (æ—¶åˆ†ä¸é¢‘åˆ†)",
                "content": "å°†è‹¥å¹²è·¯ä¿¡å·ä»¥æŸç§æ–¹å¼æ±‡åˆï¼Œç»Ÿä¸€åœ¨åŒä¸€ä¿¡é“ä¸­ä¼ è¾“ç§°ä¸ºå¤šè·¯å¤ç”¨ã€‚\næ—¶åˆ†å¤ç”¨ï¼ˆåŸç†ï¼šæŠ½æ ·å®šç†ï¼‰ï¼š\n$-f_m \\sim f_m$ çš„ä¿¡å·ï¼Œå¯ç”±é—´éš”ä¸º $1/(2f_m)$ çš„æŠ½æ ·å€¼æƒŸä¸€ç¡®å®šã€‚ä»è¿™äº›ç¬æ—¶æŠ½æ ·å€¼å¯ä»¥æ­£ç¡®æ¢å¤åŸå§‹çš„è¿ç»­ä¿¡å·ã€‚ä¿¡é“ä»…åœ¨æŠ½æ ·ç¬é—´è¢«å ç”¨ï¼Œå…¶ä½™çš„ç©ºé—²æ—¶é—´å¯ä¾›ä¼ é€ç¬¬äºŒè·¯ã€ç¬¬ä¸‰è·¯â€¦â€¦ç­‰å„è·¯æŠ½æ ·ä¿¡å·ä½¿ç”¨ã€‚å°†å„è·¯ä¿¡å·çš„æŠ½æ ·å€¼æœ‰åºåœ°æ’åˆ—å°±å¯å®ç°æ—¶åˆ†å¤ç”¨ã€‚\né¢‘åˆ†å¤ç”¨ï¼š\nåœ¨å‘é€ç«¯å°†å„è·¯ä¿¡å·é¢‘è°±æ¬ç§»åˆ°å„ä¸ç›¸åŒçš„é¢‘ç‡èŒƒå›´ï¼Œä½¿å®ƒä»¬äº’ä¸é‡å ï¼Œå³å¯å¤ç”¨åŒä¸€ä¿¡é“ä¼ è¾“ï¼›åœ¨æ¥æ”¶ç«¯åˆ©ç”¨è‹¥å¹²æ»¤æ³¢å™¨å„è·¯ä¿¡å·åˆ†ç¦»ã€‚"
            },
            {
                "title": "8. å…¨é€šç³»ç»Ÿé›¶æç‚¹åˆ†å¸ƒä¸ç›¸é¢‘ç‰¹æ€§",
                "content": "ï¼ˆ1ï¼‰å¯¹äºè¿ç»­æ—¶é—´ç³»ç»Ÿï¼Œå…¨é€šç³»ç»Ÿçš„é›¶æç‚¹å…³äº $s$ å¹³é¢è™šè½´å¯¹ç§°åˆ†å¸ƒï¼Œé›¶ç‚¹éƒ½åœ¨è™šè½´å³ä¾§ï¼Œæç‚¹éƒ½åœ¨è™šè½´å·¦ä¾§ï¼Œç›¸é¢‘ç‰¹æ€§æ˜¯å…³äºé¢‘ç‡å•è°ƒé€’å‡ï¼›\nï¼ˆ2ï¼‰å¯¹äºç¦»æ•£æ—¶é—´ç³»ç»Ÿï¼Œå…¨é€šç³»ç»Ÿçš„é›¶æç‚¹å…³äº $z$ å¹³é¢å•ä½åœ†å‘ˆé•œåƒå¯¹ç§°åˆ†å¸ƒï¼Œæç‚¹éƒ½åœ¨å•ä½åœ†å†…ï¼Œé›¶ç‚¹éƒ½åœ¨å•ä½åœ†å¤–ï¼Œç›¸é¢‘ç‰¹æ€§æ˜¯å…³äºé¢‘ç‡å•è°ƒé€’å‡ã€‚"
            },
            {
                "title": "9. DFTé¢‘è°±åˆ†æå„ç±»ç°è±¡",
                "content": "ï¼ˆ1ï¼‰é¢‘è°±æ··å ï¼šåŸå› æ˜¯å¯¹ä¿¡å·è¿›è¡Œé‡‡æ ·æ—¶ï¼Œå½“é‡‡æ ·ç‡è¿‡ä½ï¼Œå°äºä¿¡å·çš„æœ€é«˜é¢‘ç‡çš„ä¸¤å€æ—¶ï¼Œä¼šé€ æˆé¢‘åŸŸçš„æ··å ã€‚æªæ–½ï¼šå¢åŠ é‡‡æ ·é¢‘ç‡ $f_s > 2f_{max}$ï¼Œæˆ–ä½¿ç”¨æŠ—æ··å æ»¤æ³¢å™¨ã€‚\nï¼ˆ2ï¼‰é¢‘è°±æ³„éœ²ï¼šå¯¹ä¿¡å·è¿›è¡Œæˆªæ–­æ—¶ï¼Œç›¸å½“äºå·ç§¯çª—å‡½æ•°çš„é¢‘è°±ï¼Œäº§ç”Ÿæ‹–å°¾ã€‚æªæ–½ï¼šå»¶é•¿çª—é•¿åº¦ï¼›é€‰æ‹©åŠ æƒåçš„çª—å‡½æ•°ï¼ˆå¦‚æ±‰å®çª—ï¼‰ã€‚\nï¼ˆ3ï¼‰æ …æ æ•ˆåº”ï¼šDFT åªåœ¨åŸºé¢‘æ•´æ•°å€ä¸Šæœ‰è°±çº¿ï¼Œä¸­é—´çš„æ— æ³•æ˜¾ç¤ºã€‚æªæ–½ï¼šå¢åŠ æŠ½æ ·ç‚¹æ•° $N$ æˆ–æ—¶åŸŸè¡¥é›¶ã€‚\nï¼ˆ4ï¼‰è°±é—´å¹²æ‰°ï¼šæ—ç“£å¼•èµ·ä¸åŒé¢‘ç‡åˆ†é‡é—´çš„å¹²æ‰°ã€‚æªæ–½ï¼šä¸»ç“£å®½çš„çª—å‡½æ•°ã€‚"
            },
            {
                "title": "10. å‰å¸ƒæ–¯ç°è±¡",
                "content": "å½“é€‰å–çš„å‚…é‡Œå¶çº§æ•°çš„é¡¹æ•° $N$ å¢åŠ æ—¶ï¼Œåˆæˆçš„æ³¢å½¢è™½ç„¶æ›´é€¼è¿‘åŸå‡½æ•°ï¼Œä½†åœ¨ä¸è¿ç»­ç‚¹é™„è¿‘ä¼šå‡ºç°ä¸€ä¸ªå›ºå®šé«˜åº¦çš„è¿‡å†²ï¼Œå…¶å³°å€¼å¹¶ä¸ä¸‹é™ï¼Œè€Œæ˜¯å¤§çº¦ç­‰äºåŸå‡½æ•°åœ¨ä¸è¿ç»­ç‚¹å¤„è·³å˜å€¼çš„ 9%ï¼Œä¸”åœ¨ä¸è¿ç»­ç‚¹ä¸¤ä¾§å‘ˆç°è¡°å‡æŒ¯è¡çš„å½¢å¼ã€‚"
            },
            {
                "title": "11. é¢‘åŸŸé‡‡æ ·å®šç†",
                "content": "è‹¥ä¸€æœ‰é™é•¿åºåˆ— $x(n)$ çš„é•¿åº¦ä¸º $M$ï¼Œ$x(n)$ çš„ Z å˜æ¢åœ¨å•ä½åœ†ä¸Šè¿›è¡Œ $N$ ç‚¹ç­‰é—´éš”é‡‡æ ·å¾—åˆ° $X(k)=\\text{DFT}[x(n)]$ã€‚ä¸”åªæœ‰å½“ $N \\ge M$ æ—¶ï¼Œæ‰å¯ç”± $X(k)$ æ¢å¤å‡ºåŸä¿¡å· $x(n)$ã€‚"
            },
            {
                "title": "12. è„‰å†²å“åº”ä¸å˜æ³•ä¸åŒçº¿æ€§å˜æ¢æ³•",
                "content": "è„‰å†²å“åº”ä¸å˜æ³•ï¼Œæ—¶åŸŸé€¼è¿‘è‰¯å¥½ï¼Œ$\\Omega$ å’Œ $\\omega$ çº¿æ€§ç›¸å…³ï¼Œä½†é«˜é¢‘å¤„æ··å å¤±çœŸï¼›\nåŒçº¿æ€§å˜æ¢æ³•ï¼Œè§£å†³äº†é¢‘ç‡æ··å é—®é¢˜ï¼Œä½† $\\Omega$ å’Œ $\\omega$ éçº¿æ€§ã€‚"
            },
            {
                "title": "13. IIR å’Œ FIR åŒºåˆ«",
                "content": "IIR æœ‰åé¦ˆå›è·¯ï¼ŒFIR åˆ™æ²¡æœ‰ï¼›FIR å¾ˆå®¹æ˜“å®ç°çº¿æ€§ç›¸ä½ç»“æ„ï¼ŒIIR åˆ™è¾ƒéš¾ï¼›FIR æ»¤æ³¢å™¨çš„å®ç°å¯ä»¥ç”¨ FFT ç®—æ³•ï¼ŒIIR ä¸èƒ½ï¼›FIR ä¸€å®šç¨³å®šï¼ŒIIR ä¸ä¸€å®šï¼›å¦‚æœä¸è€ƒè™‘ç›¸ä½ï¼Œå®ç°ç›¸åŒçš„å¹…é¢‘ç‰¹æ€§ï¼ŒIIR çš„é˜¶æ•°æ¯” FIR çš„é˜¶æ•°è¦ä½å¾—å¤šã€‚"
            },
            {
                "title": "14. IIR æ»¤æ³¢å™¨ç»“æ„ç‰¹ç‚¹",
                "content": "çº§è”å‹ï¼šæœ‰åˆ©äºæ§åˆ¶é¢‘ç‡å“åº”ï¼Œæ–¹ä¾¿è°ƒèŠ‚é›¶æç‚¹ï¼Œä½†è¿ç®—é€Ÿåº¦æ…¢ã€‚\nå¹¶è”å‹ï¼šé€Ÿåº¦å¿«ã€è¯¯å·®å°ï¼Œä½†åªèƒ½è°ƒèŠ‚æç‚¹ï¼Œä¸èƒ½è°ƒèŠ‚é›¶ç‚¹ä½ç½®ã€‚"
            },
            {
                "title": "15. æ—¶åŸŸå°¾éƒ¨è¡¥é›¶èƒ½å¦æé«˜åˆ†è¾¨ç‡ï¼Ÿ",
                "content": "ä¸èƒ½æé«˜åˆ†è¾¨ç‡ï¼Œå› ä¸ºåºåˆ—ä¸€æ—¦ç¡®å®šï¼Œå…¶ DTFT ä¹Ÿç¡®å®šï¼Œå°¾éƒ¨è¡¥é›¶åªèƒ½æ”¹å˜å¯¹ DTFT çš„è§‚å¯Ÿæ–¹å¼ï¼Œåªæ˜¯æ¶ˆé™¤æˆ–é™ä½æ …æ æ•ˆåº”çš„ä¸€ç§æ‰‹æ®µã€‚"
            },
            {
                "title": "16. å¤šé‡‡æ ·ç‡è½¬åŒ–é—®é¢˜åŠè§£å†³",
                "content": "åœ¨ä¸Šé‡‡æ ·è¿‡ç¨‹ä¸­ï¼Œç”±äºé¢‘åŸŸçš„å‹ç¼©ï¼Œä¼šå‡ºç°å½±åƒé¢‘è°±ç°è±¡ã€‚è§£å†³ï¼šæŠ—å½±åƒæ»¤æ³¢å™¨ã€‚\nåœ¨ä¸‹é‡‡æ ·è¿‡ç¨‹ä¸­ï¼Œç”±äºæŠ½å–ä¼šé€ æˆé¢‘åŸŸçš„ä½ç§»å’Œæ‹‰ä¼¸ï¼Œå¯èƒ½ä¼šé€ æˆé¢‘è°±æ··å ã€‚è§£å†³ï¼š(1) æé«˜é‡‡æ ·é¢‘ç‡ï¼›(2) é‡‡æ ·å‰åŠ æŠ—æ··å ä½é€šæ»¤æ³¢å™¨ï¼ˆè¿‡æ»¤è¶…è¿‡ $\\frac{f_s}{2}$ çš„é¢‘ç‡ï¼‰ã€‚"
            }
        ];

        let appData = {
            config: { maskRate: 0.5 },
            currentIndex: 0,
            history: {},            // ç´¯è®¡å†å²è®°å½•ï¼ˆçƒ­åŠ›å›¾ç”¨ï¼‰
            progress: {},           // å½“å‰ç»ƒä¹ ç­”é¢˜çŠ¶æ€ï¼š{id: 'correct'|'wrong'|null}
            sessionStats: {         // å½“å‰ä¼šè¯ç»Ÿè®¡æ•°æ®
                totalWrongs: 0,
                totalAttempts: 0,
                totalTime: 0
            }
        };

        let isFocusMode = false;
        let activeElement = null;
        let startTime = 0;

        /* ================= åˆå§‹åŒ– ================= */
        function init() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                const parsed = JSON.parse(saved);
                appData.config = parsed.config || { maskRate: 0.5 };
                appData.history = parsed.history || {};
                appData.progress = parsed.progress || {};
                appData.currentIndex = parsed.currentIndex || 0;
                appData.sessionStats = parsed.sessionStats || {
                    totalWrongs: 0,
                    totalAttempts: 0,
                    totalTime: 0
                };
            }
            if (appData.currentIndex >= questions.length) appData.currentIndex = 0;

            renderStage();
            updateStats();
        }

        /* ================= æ ¸å¿ƒæ¸²æŸ“é€»è¾‘ ================= */
        function renderStage() {
            const container = document.getElementById('card-container');
            container.classList.add('fade-out');

            setTimeout(() => {
                const q = questions[appData.currentIndex];
                let html = `<div class="card-title">${q.title}</div>`;
                
                // 1. ç”Ÿæˆå¸¦æœ‰ LaTeX å…¬å¼ ($...$) çš„ HTML
                html += `<div class="card-content" id="q-content">${processMixedText(q.content, appData.currentIndex, 'practice')}</div>`;
                
                container.innerHTML = html;
                
                // 2. ç­‰å¾… KaTeX åŠ è½½å®Œæˆåæ¸²æŸ“å…¬å¼
                if (typeof renderMathInElement === 'function') {
                    renderMathInElement(document.getElementById('q-content'), {
                        delimiters: [
                            {left: "$$", right: "$$", display: true},
                            {left: "$", right: "$", display: false}
                        ],
                        throwOnError: false
                    });
                } else {
                    // KaTeX è¿˜æœªåŠ è½½ï¼Œç­‰å¾…åé‡è¯•
                    setTimeout(() => {
                        if (typeof renderMathInElement === 'function') {
                            renderMathInElement(document.getElementById('q-content'), {
                                delimiters: [
                                    {left: "$$", right: "$$", display: true},
                                    {left: "$", right: "$", display: false}
                                ],
                                throwOnError: false
                            });
                        }
                    }, 1000);
                }

                container.classList.remove('fade-out');

                // UI æ›´æ–°
                document.getElementById('progress-text').textContent = `${appData.currentIndex + 1} / ${questions.length}`;
                document.getElementById('btn-prev').disabled = appData.currentIndex === 0;

                // æ›´æ–°ä¸‹ä¸€é¢˜æŒ‰é’®çŠ¶æ€å’Œæ–‡æœ¬
                const btnNext = document.getElementById('btn-next');
                if (appData.currentIndex === questions.length - 1) {
                    btnNext.textContent = 'é‡ç½®ç»ƒä¹ ';
                    btnNext.disabled = false; // ç¡®ä¿æŒ‰é’®å¯ç‚¹å‡»
                } else {
                    btnNext.textContent = 'ä¸‹ä¸€é¢˜';
                    btnNext.disabled = false;
                }
            }, 200);
        }

        // --- ç¨³å®šéšæœºæ•°ç”Ÿæˆå™¨ ---
        function getSeededRandom(qIdx) {
            // ä¸ºæ¯ä¸ªé¢˜ç›®ç”Ÿæˆå›ºå®šçš„éšæœºç§å­
            let seed = qIdx * 1000 + 1;
            return function() {
                seed = (seed * 9301 + 49297) % 233280;
                return seed / 233280;
            };
        }

        // --- æ ¸å¿ƒåˆ†è¯ç®—æ³•ï¼šæ··åˆ LaTeX å’Œ æ™®é€šæ–‡æœ¬ ---
        function processMixedText(text, qIdx, mode) {
            // ä½¿ç”¨ç¨³å®šéšæœºæ•°ç”Ÿæˆå™¨
            const random = getSeededRandom(qIdx);

            // æ­£åˆ™ï¼šåˆ†å‰² LaTeX å…¬å¼ ($...$)
            // ä½¿ç”¨ capturing group () ä½¿å¾— split ä¿ç•™åˆ†éš”ç¬¦
            const parts = text.split(/(\$[^$]+\$)/g);

            let mCount = 0;

            // éå†ç‰‡æ®µ
            return parts.map(part => {
                // æƒ…å†µA: æ˜¯ LaTeX å…¬å¼
                if (part.startsWith('$') && part.endsWith('$')) {
                    // åˆ¤æ–­æ˜¯å¦éœ€è¦é®æŒ¡ (å…¬å¼ä½œä¸ºæ•´ä½“é®æŒ¡)
                    // ä½¿ç”¨ç¨³å®šéšæœºæ•°
                    const shouldMask = random() < appData.config.maskRate; 
                    
                    if (shouldMask) {
                        return createMaskElement(part, qIdx, mCount++, mode, true); // trueè¡¨ç¤ºæ˜¯å…¬å¼
                    } else {
                        // ä¸é®æŒ¡ï¼Œç›´æ¥è¿”å›åŸå…¬å¼æ–‡æœ¬ï¼Œç¨åç”±KaTeXæ¸²æŸ“
                        return part; 
                    }
                } 
                // æƒ…å†µB: æ˜¯æ™®é€šæ–‡æœ¬
                else {
                    // å†…éƒ¨å†è¿›è¡Œåˆ†è¯å¤„ç†
                    return part.replace(/([^ï¼Œã€‚ï¼›ï¼šã€ï¼Ÿï¼\s\n\(\)ï¼ˆï¼‰<>=]+)/g, (match) => {
                        // æ–‡æœ¬é®æŒ¡é€»è¾‘ - ä½¿ç”¨ç¨³å®šéšæœºæ•°
                        let isMasked = random() < appData.config.maskRate && match.length > 1;
                        if (isMasked) {
                            return createMaskElement(match, qIdx, mCount++, mode, false);
                        }
                        return match;
                    }).replace(/\n/g, '<br>');
                }
            }).join('');
        }

        // ç”Ÿæˆé®æŒ¡å—çš„ç»Ÿä¸€å‡½æ•°
        function createMaskElement(content, qIdx, mIdx, mode, isMath) {
            const id = `q${qIdx}_m${mIdx}`;
            
            if (mode === 'heatmap') {
                const rec = appData.history[id];
                const wrongs = rec ? rec.wrong : 0;
                let bg = 'transparent';
                let color = 'inherit';

                if (rec) {
                     if (wrongs >= 8) { bg = 'var(--heat-4)'; color='#fff'; }
                     else if (wrongs >= 5) { bg = 'var(--heat-3)'; color='#fff'; }
                     else if (wrongs >= 3) { bg = 'var(--heat-2)'; }
                     else if (wrongs >= 1) { bg = 'var(--heat-1)'; }
                     else { bg = 'var(--heat-0)'; }
                }
                
                // çƒ­åŠ›å›¾æ¨¡å¼ç›´æ¥è¿”å›å†…å®¹ï¼Œå› ä¸ºä¹‹åä¼šç»Ÿä¸€æ¸²æŸ“KaTeX
                return `<span class="heat-span" style="background:${bg}; color:${color}">${content}</span>`;
            } else {
                // ç»ƒä¹ æ¨¡å¼ - ä½¿ç”¨æŒä¹…åŒ–è¿›åº¦æ•°æ®
                const progress = appData.progress[id];
                let cls = 'cloze masked';
                let action = `onclick="enterFocus(event, this, '${id}')"`;

                if (progress === 'correct') { cls = 'cloze correct'; action = ''; }
                if (progress === 'wrong') { cls = 'cloze wrong'; action = ''; }
                
                // å¦‚æœæ˜¯å…¬å¼ï¼Œå†…å®¹å°±æ˜¯ $...$ï¼ŒKaTeXæ¸²æŸ“åä¼šç”Ÿæˆå¤æ‚çš„spanç»“æ„ã€‚
                // CSS ä¸­ .cloze.masked .katex { opacity: 0 } ä¼šéšè—å®ƒ
                return `<span id="${id}" class="${cls}" ${action}>${content}</span>`;
            }
        }

        /* ================= äº¤äº’é€»è¾‘ ================= */
        window.enterFocus = function(e, el, id) {
            if (isFocusMode) return;
            e.stopPropagation();

            isFocusMode = true;
            activeElement = el;
            startTime = Date.now();

            el.classList.remove('masked');
            el.classList.add('active-focus');
            document.getElementById('focus-overlay').classList.add('active');

            const menu = document.getElementById('decision-menu');
            const rect = el.getBoundingClientRect();
            menu.style.display = 'block';
            
            let top = rect.top - 60;
            let left = rect.left + (rect.width/2) - 80;
            if (top < 20) top = rect.bottom + 20;
            if (left < 10) left = 10;
            if (left + 160 > window.innerWidth) left = window.innerWidth - 170;
            
            menu.style.top = top + 'px';
            menu.style.left = left + 'px';
        };

        window.submitJudgment = function(isCorrect) {
            if (!activeElement) return;
            const duration = Date.now() - startTime;
            const id = activeElement.id;

            // æ›´æ–°ç´¯è®¡å†å²è®°å½•ï¼ˆçƒ­åŠ›å›¾ç”¨ï¼‰
            if (!appData.history[id]) appData.history[id] = { wrong: 0, correct: 0, totalTime: 0, attempts: 0 };
            const rec = appData.history[id];
            rec.attempts++;
            rec.totalTime += duration;
            if (isCorrect) rec.correct++; else rec.wrong++;

            // æ›´æ–°å½“å‰ä¼šè¯ç»Ÿè®¡
            appData.sessionStats.totalAttempts++;
            appData.sessionStats.totalTime += duration;
            if (!isCorrect) appData.sessionStats.totalWrongs++;

            // æŒä¹…åŒ–ä¿å­˜ç­”é¢˜çŠ¶æ€
            appData.progress[id] = isCorrect ? 'correct' : 'wrong';
            saveData();
            updateStats();
            playTone(isCorrect);

            activeElement.classList.remove('active-focus');
            activeElement.classList.add(isCorrect ? 'correct' : 'wrong');
            activeElement.onclick = null;
            exitFocus();
        };

        function exitFocus() {
            isFocusMode = false;
            activeElement = null;
            document.getElementById('focus-overlay').classList.remove('active');
            document.getElementById('decision-menu').style.display = 'none';
        }

        /* ================= ç»Ÿè®¡ & è®¾ç½® ================= */
        function updateStats() {
            // ä½¿ç”¨å½“å‰ä¼šè¯ç»Ÿè®¡æ•°æ®
            const sessionStats = appData.sessionStats;
            const totalWrongs = sessionStats.totalWrongs;
            const totalAttempts = sessionStats.totalAttempts;
            const totalTime = sessionStats.totalTime;

            document.getElementById('disp-wrong-count').textContent = totalWrongs;

            let rate = totalAttempts > 0 ? Math.round((totalWrongs / totalAttempts) * 100) : 0;
            const rateEl = document.getElementById('disp-error-rate');
            rateEl.textContent = rate + '%';
            rateEl.className = 'stat-value ' + (rate > 20 ? 'bad' : 'good');

            let avg = totalAttempts > 0 ? (totalTime / totalAttempts / 1000).toFixed(1) : 0;
            document.getElementById('disp-avg-time').textContent = avg + 's';
        }

        window.openHeatmap = function() {
            if (isFocusMode) return;
            const q = questions[appData.currentIndex];
            // 1. ç”ŸæˆHTML
            const html = `
                <h3 style="margin-bottom:15px; font-weight:700;">${q.title}</h3>
                <div id="heatmap-body-content" style="line-height:2.4;">${processMixedText(q.content, appData.currentIndex, 'heatmap')}</div>
            `;
            document.getElementById('heatmap-content').innerHTML = html;
            
            // 2. ç­‰å¾… KaTeX åŠ è½½å®Œæˆåæ¸²æŸ“å…¬å¼
            if (typeof renderMathInElement === 'function') {
                renderMathInElement(document.getElementById('heatmap-body-content'), {
                    delimiters: [{left: "$", right: "$", display: false}]
                });
            } else {
                // KaTeX è¿˜æœªåŠ è½½ï¼Œç­‰å¾…åé‡è¯•
                setTimeout(() => {
                    if (typeof renderMathInElement === 'function') {
                        renderMathInElement(document.getElementById('heatmap-body-content'), {
                            delimiters: [{left: "$", right: "$", display: false}]
                        });
                    }
                }, 1000);
            }
            
            document.getElementById('heatmap-modal').classList.add('open');
        };

        window.openSettings = function() {
            if (isFocusMode) return;
            const val = appData.config.maskRate * 100;
            document.getElementById('rate-slider').value = val;
            updateSliderUI(val);
            document.getElementById('settings-modal').classList.add('open');
        };

        window.closeModal = function(id) { document.getElementById(id).classList.remove('open'); };
        window.updateSliderUI = function(val) { document.getElementById('setting-rate-val').textContent = val + '%'; };

        window.saveSettings = function() {
            const newVal = document.getElementById('rate-slider').value / 100;
            if (newVal !== appData.config.maskRate) {
                appData.config.maskRate = newVal;
                appData.progress = {}; // æ¸…ç©ºè¿›åº¦ï¼Œå› ä¸ºé®æŒ¡æ¨¡å¼æ”¹å˜äº†
                saveData();
                renderStage();
            }
            closeModal('settings-modal');
        };

        window.resetAllData = function() {
            if(confirm('è­¦å‘Šï¼šå°†åˆ é™¤æ‰€æœ‰æ•°æ®ï¼')) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        };

        function changePage(delta) {
            if (isFocusMode) return;
            const next = appData.currentIndex + delta;

            // Check if trying to go beyond last question
            if (delta > 0 && next >= questions.length) {
                showResetDialog();
                return;
            }

            if (next >= 0 && next < questions.length) {
                appData.currentIndex = next;
               
                saveData();
                renderStage();
            }
        }

        function saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(appData)); }

        // --- Reset Modal Functions ---
        function showResetDialog() {
            document.getElementById('reset-overlay').classList.add('active');
        }

        function hideResetDialog() {
            document.getElementById('reset-overlay').classList.remove('active');
        }

        window.confirmReset = function() {
            // Reset to first question and clear progress + sessionStats, keep history (çƒ­åŠ›å›¾)
            appData.currentIndex = 0;
            appData.progress = {};
            appData.sessionStats = {
                totalWrongs: 0,
                totalAttempts: 0,
                totalTime: 0
            };
            saveData();
            renderStage();
            updateStats(); // æ¸…ç©ºç»Ÿè®¡æ˜¾ç¤º
            hideResetDialog();
        };

        window.cancelReset = function() {
            hideResetDialog();
        };

        // éŸ³æ•ˆ
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playTone(isSuccess) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;
            if (isSuccess) {
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.exponentialRampToValueAtTime(1000, now + 0.1);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
            } else {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(150, now);
                gain.gain.setValueAtTime(0.15, now);
                gain.gain.linearRampToValueAtTime(0.01, now + 0.2);
            }
            osc.start(now);
            osc.stop(now + 0.3);
        }

        // ç¡®ä¿ KaTeX åº“åŠ è½½å®Œæˆåå†åˆå§‹åŒ–åº”ç”¨
        function initApp() {
            if (typeof renderMathInElement === 'function') {
                init();
            } else {
                setTimeout(initApp, 100);
            }
        }

        initApp();
    </script>
</body>
</html>